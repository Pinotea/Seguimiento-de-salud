<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seguimiento de Salud</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        input[type="text"], input[type="number"], select, textarea {
            color: #333;
            background-color: rgba(255, 255, 255, 0.8);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen text-white py-8">
    <div class="container mx-auto px-4">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold mb-4">SEGUIMIENTO DE SALUD</h1>
        </header>

        <nav class="mb-8 flex flex-wrap justify-center gap-2">
            <button id="irInicio" class="px-3 py-2 text-xs border border-transparent font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Inicio</button>
            <button id="irRegistro" class="px-3 py-2 text-xs border border-transparent font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Registrar Medición</button>
            <button id="irHistorial" class="px-3 py-2 text-xs border border-transparent font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Ver Historial</button>
            <button id="irGraficos" class="px-3 py-2 text-xs border border-transparent font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Ver Gráficos</button>
        </nav>

        <div id="inicio" class="w-full max-w-md mx-auto">
            <div class="card rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-center">Datos Personales</h2>
                <form id="datosPersonalesForm" class="space-y-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium">Nombre</label>
                        <input type="text" id="nombre" required class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                    </div>
                    <div>
                        <label for="edad" class="block text-sm font-medium">Edad</label>
                        <input type="number" id="edad" required min="0" max="120" class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Guardar Datos Personales
                    </button>
                </form>
            </div>
        </div>

        <div id="registro" class="w-full max-w-md mx-auto hidden">
            <div class="card rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-center">Registrar Medición</h2>
                <form id="medicionForm" class="space-y-4">
                    <div>
                        <label for="fechaMedicion" class="block text-sm font-medium">Fecha y Hora</label>
                        <input type="text" id="fechaMedicion" required class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                    </div>
                    <div>
                        <label for="tipoMedicion" class="block text-sm font-medium">Tipo de Medición</label>
                        <select id="tipoMedicion" required class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                            <option value="">Seleccione el tipo</option>
                            <option value="presion">Presión Arterial</option>
                            <option value="glucosa">Nivel de Glucosa</option>
                        </select>
                    </div>
                    <div id="camposPresion" class="hidden">
                        <div>
                            <label for="sistolica" class="block text-sm font-medium">Presión Sistólica (mmHg)</label>
                            <input type="number" id="sistolica" min="0" max="300" class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                        </div>
                        <div>
                            <label for="diastolica" class="block text-sm font-medium">Presión Diastólica (mmHg)</label>
                            <input type="number" id="diastolica" min="0" max="200" class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                        </div>
                    </div>
                    <div id="camposGlucosa" class="hidden">
                        <div>
                            <label for="nivelGlucosa" class="block text-sm font-medium">Nivel de Glucosa (mg/dL)</label>
                            <input type="number" id="nivelGlucosa" min="0" max="600" class="mt-1 block w-full px-3 py-2 border border-transparent rounded-md">
                        </div>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Guardar Medición
                    </button>
                </form>
            </div>
        </div>

        <div id="historial" class="w-full max-w-4xl mx-auto hidden">
            <div class="card rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-center">Historial de Mediciones</h2>
                <div id="listaMediciones" class="space-y-4">
                    <!-- Las mediciones se insertarán aquí -->
                </div>
            </div>
        </div>

        <div id="graficos" class="w-full max-w-4xl mx-auto hidden">
            <div class="card rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-center">Gráficos de Mediciones</h2>
                <div id="presionArterialChartContainer" class="mb-4">
                    <canvas id="presionArterialChart"></canvas>
                </div>
                <div id="glucosaChartContainer">
                    <canvas id="glucosaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification" role="alert"></div>

    <script>
        // Configuración de IndexedDB
        const dbPromise = idb.openDB('SaludDB', 1, {
            upgrade(db) {
                db.createObjectStore('datosPersonales');
                db.createObjectStore('mediciones', { keyPath: 'id', autoIncrement: true });
            },
        });

        // Funciones de almacenamiento
        async function guardarDatosPersonales(datos) {
            const db = await dbPromise;
            await db.put('datosPersonales', datos, 'datos');
        }

        async function obtenerDatosPersonales() {
            const db = await dbPromise;
            return db.get('datosPersonales', 'datos');
        }

        async function guardarMedicion(medicion) {
            const db = await dbPromise;
            return db.add('mediciones', medicion);
        }

        async function obtenerMediciones() {
            const db = await dbPromise;
            return db.getAll('mediciones');
        }

        async function eliminarMedicion(id) {
            const db = await dbPromise;
            await db.delete('mediciones', id);
        }

        // Funciones de la interfaz de usuario
        function mostrarVista(vista) {
            document.getElementById('inicio').classList.add('hidden');
            document.getElementById('registro').classList.add('hidden');
            document.getElementById('historial').classList.add('hidden');
            document.getElementById('graficos').classList.add('hidden');
            document.getElementById(vista).classList.remove('hidden');

            if (vista === 'inicio') {
                cargarDatosPersonales();
            } else if (vista === 'historial') {
                cargarHistorial();
            } else if (vista === 'graficos') {
                cargarGraficos();
            }
        }

        async function cargarDatosPersonales() {
            const datos = await obtenerDatosPersonales();
            if (datos) {
                document.getElementById('nombre').value = datos.nombre || '';
                document.getElementById('edad').value = datos.edad || '';
            }
        }

        async function cargarHistorial() {
            const listaMediciones = document.getElementById('listaMediciones');
            listaMediciones.innerHTML = '';
            const mediciones = await obtenerMediciones();

            if (mediciones.length === 0) {
                listaMediciones.innerHTML = '<p>No hay mediciones registradas.</p>';
                return;
            }

            mediciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            mediciones.forEach(medicion => {
                const medicionElement = document.createElement('div');
                medicionElement.className = 'bg-white/10 p-4 rounded-md';
                let contenido = `
                    <p><strong>Fecha:</strong> ${new Date(medicion.fecha).toLocaleString('es-ES')}</p>
                    <p><strong>Tipo:</strong> ${medicion.tipo === 'presion' ? 'Presión Arterial' : 'Nivel de Glucosa'}</p>
                `;
                if (medicion.tipo === 'presion') {
                    contenido += `
                        <p><strong>Presión Sistólica:</strong> ${medicion.sistolica} mmHg</p>
                        <p><strong>Presión Diastólica:</strong> ${medicion.diastolica} mmHg</p>
                    `;
                } else {
                    contenido += `
                        <p><strong>Nivel de Glucosa:</strong> ${medicion.nivelGlucosa} mg/dL</p>
                    `;
                }
                contenido += `
                    <button class="eliminarMedicion mt-2 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600" data-id="${medicion.id}">
                        Eliminar
                    </button>
                `;
                medicionElement.innerHTML = contenido;
                listaMediciones.appendChild(medicionElement);
            });

            document.querySelectorAll('.eliminarMedicion').forEach(button => {
                button.addEventListener('click', async function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('¿Está seguro de que desea eliminar esta medición?')) {
                        await eliminarMedicion(id);
                        cargarHistorial();
                    }
                });
            });
        }

        async function cargarGraficos() {
            const mediciones = await obtenerMediciones();
            const presionArterialData = mediciones.filter(m => m.tipo === 'presion');
            const glucosaData = mediciones.filter(m => m.tipo === 'glucosa');

            if (window.presionArterialChart) {
                window.presionArterialChart.destroy();
            }
            if (window.glucosaChart) {
                window.glucosaChart.destroy();
            }

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'dd/MM/yyyy'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };

            if (presionArterialData.length > 0) {
                const ctx1 = document.getElementById('presionArterialChart').getContext('2d');
                window.presionArterialChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Presión Sistólica',
                                data: presionArterialData.map(d => ({ x: new Date(d.fecha), y: d.sistolica })),
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            },
                            {
                                label: 'Presión Diastólica',
                                data: presionArterialData.map(d => ({ x: new Date(d.fecha), y: d.diastolica })),
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Presión (mmHg)'
                                }
                            }
                        }
                    }
                });
                document.getElementById('presionArterialChartContainer').style.display = 'block';
            } else {
                document.getElementById('presionArterialChartContainer').style.display = 'none';
            }

            if (glucosaData.length > 0) {
                const ctx2 = document.getElementById('glucosaChart').getContext('2d');
                window.glucosaChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Nivel de Glucosa',
                            data: glucosaData.map(d => ({ x: new Date(d.fecha), y: d.nivelGlucosa })),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    display: true,
                                    text: 'Nivel de Glucosa (mg/dL)'
                                }
                            }
                        }
                    }
                });
                document.getElementById('glucosaChartContainer').style.display = 'block';
            } else {
                document.getElementById('glucosaChartContainer').style.display = 'none';
            }
        }

        function mostrarNotificacion(mensaje) {
            const notification = document.getElementById('notification');
            notification.textContent = mensaje;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Event Listeners
        document.getElementById('irInicio').addEventListener('click', () => mostrarVista('inicio'));
        document.getElementById('irRegistro').addEventListener('click', () => mostrarVista('registro'));
        document.getElementById('irHistorial').addEventListener('click', () => mostrarVista('historial'));
        document.getElementById('irGraficos').addEventListener('click', () => mostrarVista('graficos'));

        document.getElementById('tipoMedicion').addEventListener('change', function() {
            document.getElementById('camposPresion').classList.add('hidden');
            document.getElementById('camposGlucosa').classList.add('hidden');
            if (this.value === 'presion') {
                document.getElementById('camposPresion').classList.remove('hidden');
            } else if (this.value === 'glucosa') {
                document.getElementById('camposGlucosa').classList.remove('hidden');
            }
        });

        document.getElementById('datosPersonalesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const datos = {
                nombre: document.getElementById('nombre').value,
                edad: parseInt(document.getElementById('edad').value)
            };
            await guardarDatosPersonales(datos);
            mostrarNotificacion('Datos personales guardados con éxito');
        });

        document.getElementById('medicionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fecha = document.getElementById('fechaMedicion').value;
            const tipo = document.getElementById('tipoMedicion').value;
            let medicion = { fecha, tipo };

            if (tipo === 'presion') {
                medicion.sistolica = parseInt(document.getElementById('sistolica').value);
                medicion.diastolica = parseInt(document.getElementById('diastolica').value);
            } else if (tipo === 'glucosa') {
                medicion.nivelGlucosa = parseInt(document.getElementById('nivelGlucosa').value);
            }

            await guardarMedicion(medicion);
            mostrarNotificacion('Medición guardada con éxito');
            this.reset();
            document.getElementById('camposPresion').classList.add('hidden');
            document.getElementById('camposGlucosa').classList.add('hidden');
        });

        // Inicialización
        flatpickr("#fechaMedicion", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            locale: "es"
        });

        mostrarVista('inicio');
    </script>
</body>
</html>

